<% @sign = present(@sign) %>
<div class="grid-x grid-margin-x content-container">
  <%= render "errors" %>
  <%= form_with model: @sign, url: sign_path(@sign), local: true, class: "cell form", method: :patch do |f| %>
    <h1 class="">Edit sign details</h1>
    <hr class="form__divider"/>

    <div class="row align-middle small-12 js-sign-video-container">
      <div class="small-12 medium-6"><%= render "signs/card/video", sign: @sign %></div>
      <b class="small-12 medium-6"><%=@sign.word %></b>
    </div>

    <fieldset class="content-container">
      <%= f.label :word, "Sign / word:", class: "required" %>
      <%= f.text_field :word, class: (@sign.errors[:word].any? && "invalid") %>
      <% if @sign.errors[:word].any? %>
        <% @sign.errors[:word].each do |message| %>
          <div class="form-error show"><%= message %></div>
        <% end %>
      <% end %>
    </fieldset>
    <fieldset>
      <%= f.label :secondary, "Other words for this sign:" %>
      <%= f.text_field :secondary, class: (@sign.errors[:secondary].any? && "invalid") %>
    </fieldset>
    <fieldset>
      <%= f.label :maori, "Māori translation:" %>
      <%= f.text_field :maori, class: (@sign.errors[:maori].any? && "invalid") %>
    </fieldset>
    <fieldset>
      <%= f.label :topic_id, "Topic:" %>
      <%= f.collection_select :topic_id, Topic.all, :id, :name %>
    </fieldset>
    <fieldset>
      <%= f.label :notes, "Notes (e.g. where have you seen the sign used?):" %>
      <%= f.text_area :notes, rows: 5, class: (@sign.errors[:notes].any? && "invalid") %>
    </fieldset>

    <br/>
    <h2 class="">Public</h2>
    <hr class="form__divider"/>
    <br/>
    <%= label :should_submit_for_publishing, "Do you want your sign to be public?" do %>
      <span>
        <h3>Do you want your sign to be public?</h3>
        <p> Your sign will go through a validation process with our NZSL Share moderators before it is published. </p>
      </span>
    <% end %>
    <br/>
    <fieldset>
      <%= radio_button_tag(:should_submit_for_publishing, "true", !!@sign.submitted_to_publish?) %>
        <%= label_tag(:should_submit_for_publishing_true, "Yes, request my sign be public") %>
    </fieldset>
    <br/>
    <fieldset>
      <%= radio_button_tag(:should_submit_for_publishing, "false", !@sign.submitted_to_publish?) %>
        <%= label_tag(:should_submit_for_publishing_false, "No, keep my sign private") %>
    </fieldset>
    <br/>
    <br/>
    <div id="terms_and_conditions">
      <h2 class="">Terms and Conditions</h2>
      <hr class="form__divider"/>
      <br/>
      <fieldset>
        <%= f.check_box :conditions_accepted, class: (@sign.errors[:secondary].any? && "invalid")%>
        <%= f.label :conditions_accepted, "I agree to follow the terms and conditions (rules)" %>
      </fieldset>
    </div>
    <br/>
    <hr class="form__divider"/>
    <div class="grid-x form__buttons align-justify">
      <div class="pull-left">
        <%= link_to t("signs.destroy.link"),
                    sign_path(@sign),
                    method: :delete,
                    data: { confirm: t("signs.destroy.confirm") },
                    class: "button alert" %>
      </div>

      <div class="pull-right">
        <%= link_to "Cancel", sign_path(@sign), class: "button clear form__buttons--cancel" %>
        <%= f.submit class: "button royal primary" %>
      </div>
    </div>
  <% end %>
</div>


<%= javascript_tag defer: "defer", nonce: true do %>
  $(document).on("DOMContentLoaded", () => {
    console.log('why not?')
    $("#terms_and_conditions").hide()
  });
  $(document).on("change", "input[type=radio][id='should_submit_for_publishing_true']", event => {
    console.log('why no?')
    $("#terms_and_conditions").show()
    $("#sign_conditions_accepted").prop('required', true);
  });
  $(document).on("change", "input[type=radio][id='should_submit_for_publishing_false']", event => {
    console.log('why nottttt?')
    $("#terms_and_conditions").hide()
    $("#sign_conditions_accepted").prop('required', false);
  });
<% end %>

<% unless @sign.fully_processed? %>
  <%= javascript_tag defer: "defer", nonce: true do %>
    var selector = ".js-sign-video-container";
    var updateInterval = <%= Rails.env.test? ? 500 : 5000 %>; // ms
    var intervalId

    function refresh() {
      var $currentContainer = jQuery(selector);
      var $currentVideo = $currentContainer.find("video.sign-video");
      jQuery.ajax( {
        url: window.location,
        dataType: "html"
      }).done(function(responseText) {
        var $newVideoContainer = jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector);
        var $newVideo = $newVideoContainer.find("video.sign-video");

        // Stop polling once the video has been processed
        if ($newVideo.hasClass("has-video")) clearInterval(intervalId);

        // Only refresh the HTML of the element if the classes of the video have changed
        if ($newVideo.get(0).classList.value !== $currentVideo.get(0).classList.value) {
          $currentContainer.html($newVideoContainer.html());
        }
      });
    }

    jQuery(function() {
      intervalId = setInterval(refresh, updateInterval);
    });
  <% end %>
<% end %>
